<script src="https://cdn.tailwindcss.com"></script>
<!-- Configuraciones de Tailwind para el dise√±o -->
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'indigo': {
                        '600': '#4f46e5',
                        '700': '#4338ca',
                    },
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
            }
        }
    }
</script>
<style>
    body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
    .container { max-width: 1200px; }
    .match-card {
        animation: fadeIn 0.5s ease-out;
        margin-bottom: 1rem;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .match-card.completed {
        border-left: 5px solid #10b981; /* Green line */
        opacity: 0.8;
    }
    /* Estilo para que las secciones de ranking se vean bien en m√≥vil y desktop */
    .group-section {
        min-width: 300px; 
    }
    @media (max-width: 768px) {
        .group-section {
            width: 100%;
        }
    }

    .score-inputs input[type="number"] {
        -moz-appearance: textfield;
    }
    .score-inputs input::-webkit-outer-spin-button,
    .score-inputs input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

<div class="container mx-auto p-4 md:p-8">

    <header class="text-center mb-10">
        <!-- T√çTULO ACTUALIZADO A TENIS -->
        <h1 class="text-4xl font-extrabold text-indigo-700">üéæ Torneo de Tenis üéæ</h1>
        <!-- Display de ID del Torneo -->
        <div id="tournament-id-display">
            <p class="text-sm text-gray-500 mt-2">Torneo no iniciado o ID no disponible.</p>
        </div>
    </header>

    <!-- Secci√≥n de Carga Externa (Secci√≥n que arreglamos en el paso anterior) -->
    <section id="cargar-torneo-externo" class="mt-8 p-6 bg-yellow-50 rounded-xl shadow-lg border border-yellow-200">
        <h3 class="text-xl font-bold text-yellow-800 mb-4">Cargar Torneo Existente üîÑ</h3>
        <form id="load-tournament-form">
            <div class="mb-4">
                <label for="external-id-input" class="block text-sm font-medium text-gray-700">ID del Torneo</label>
                <input type="text" id="external-id-input" required placeholder="Pega el ID aqu√≠ (ej: nP2o3Tf6uYceS0iLed6a)"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
            </div>
            <button type="submit" 
                    class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                Cargar Torneo
            </button>
            <!-- ELEMENTO CR√çTICO PARA MENSAJES DE ERROR/√âXITO DE CARGA -->
            <p id="load-message" class="text-center mt-2 text-sm text-red-600"></p>
        </form>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-10">
        
        <!-- COLUMNA 1: CONFIGURACI√ìN Y REGISTRO -->
        <div class="lg:col-span-1 space-y-8">
            
            <!-- CONFIGURACI√ìN (Actualizada con input de Grupos) -->
            <section id="configuracion" class="p-6 bg-white rounded-xl shadow-xl">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Configuraci√≥n Inicial</h3>
                
                <div class="space-y-4">
                    <!-- Configurar M√°ximo de Jugadores -->
                    <div>
                        <label for="max-jugadores-input" class="block text-sm font-medium text-gray-700">M√°ximo de Jugadores (Par, M√≠n. 4)</label>
                        <input type="number" id="max-jugadores-input" min="4" step="2" value="10" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <button onclick="configurarMaxJugadores()" 
                                class="mt-2 w-full py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-sm font-medium">
                            Establecer M√°ximo (<span id="max-jugadores-actual">10</span>)
                        </button>
                    </div>

                    <!-- Configurar N√∫mero de Grupos (NUEVO CONTROL A√ëADIDO) -->
                    <div>
                        <label for="num-grupos-input" class="block text-sm font-medium text-gray-700">N√∫mero de Grupos (1 a 6)</label>
                        <input type="number" id="num-grupos-input" min="1" max="6" value="2" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <button onclick="configurarNumGrupos()" 
                                class="mt-2 w-full py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-sm font-medium">
                            Establecer Grupos
                        </button>
                    </div>
                </div>
            </section>

            <!-- REGISTRO DE PARTICIPANTES -->
            <section id="registro" class="p-6 bg-white rounded-xl shadow-xl">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Registro de Participantes</h3>
                <p class="text-sm text-gray-600 mb-4">
                    <span id="contador-participantes">0</span> / <span id="max-participantes-display">10</span> registrados.
                </p>

                <div class="flex space-x-2 mb-6">
                    <input type="text" id="nombre-input" placeholder="Nombre del jugador" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    <button onclick="agregarParticipante()" class="bg-indigo-600 text-white p-2 rounded-md shadow-md hover:bg-indigo-700 transition duration-150">
                        A√±adir
                    </button>
                </div>
                
                <ul id="lista-participantes" class="space-y-2 text-gray-700 list-disc list-inside">
                    <!-- Jugadores se listan aqu√≠ -->
                </ul>

                <button id="btn-iniciar" onclick="iniciarTorneo()" disabled
                        class="mt-6 w-full py-3 px-4 rounded-xl font-bold text-white bg-green-500 disabled:bg-gray-400 hover:bg-green-600 transition duration-150 shadow-lg">
                    Iniciar Torneo
                </button>
            </section>

            <!-- ACCIONES ADICIONALES -->
            <section id="acciones-adicionales" class="p-6 bg-white rounded-xl shadow-xl">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Herramientas</h3>
                <button onclick="borrarDatos()" 
                        class="w-full py-2 px-4 rounded-md text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-md">
                    ‚ö†Ô∏è Borrar Todo (Reiniciar)
                </button>
                <button id="btn-generate-analysis" onclick="generateTournamentAnalysis()" 
                        class="mt-3 w-full py-2 px-4 rounded-md text-sm font-medium text-white bg-yellow-500 hover:bg-yellow-600 transition duration-150 shadow-md"
                        style="display:none;">
                    Generar An√°lisis Estrat√©gico ‚ú®
                </button>
                <div id="analysis-results" class="mt-4">
                    <!-- Resultados del an√°lisis de Gemini se muestran aqu√≠ -->
                </div>
            </section>
        </div>

        <!-- COLUMNA 2 & 3: GRUPOS, RANKING Y FIXTURE -->
        <div class="lg:col-span-2 space-y-8">

            <!-- FASE DE GRUPOS Y RANKING -->
            <section id="grupos-fixture" style="display:none;" class="p-6 bg-white rounded-xl shadow-xl">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6">Fase de Grupos de Tenis</h2>
                
                <!-- Contenedor para los Grupos y su Ranking. CLAVE: flex-wrap para responsividad. -->
                <div id="grupos-container" class="flex flex-wrap -mx-2">
                    <!-- Los rankings y listados de grupos se inyectan aqu√≠ con la tabla de puntos -->
                </div>

                <!-- Registro de Resultados de Grupos -->
                <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-t pt-4">Registro de Marcadores (Sets Ganados)</h3>
                <div id="partidos-registro-grupos" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Los partidos con sus inputs se inyectan aqu√≠ -->
                </div>
            </section>

            <!-- PLAYOFFS Y RANKING FINAL -->
            <section id="ranking-finales" style="display:none;" class="p-6 bg-white rounded-xl shadow-xl">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6">Playoffs y Clasificaci√≥n Final</h2>
                <div id="playoffs-bracket">
                    <!-- Corchete de playoffs se inyecta aqu√≠ -->
                </div>
                
                <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-t pt-4">Clasificaci√≥n Final</h3>
                <div id="final-ranking">
                    <!-- Ranking final se inyecta aqu√≠ -->
                </div>

            </section>

        </div>
    </div>
</div>

<!-- Carga de las librer√≠as de Firebase y la l√≥gica del torneo -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // Mantenemos la importaci√≥n de 'firebase' para tener acceso a firebase.firestore.FieldValue.serverTimestamp()
    import firebase from "https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js";
    import "https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js";
    
    // VARIABLES GLOBALES DEL ENTORNO CANVAS (MANDATORIAS)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    // const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // Inicializaci√≥n de Firebase
    if (Object.keys(firebaseConfig).length > 0) {
        // Usa la sintaxis de v8 para la inicializaci√≥n y acceso, ya que se usa en el JS de l√≥gica.
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        window.db = firebase.firestore();
        // Nota: Las reglas de seguridad de Firestore permiten la lectura y escritura.
    } else {
        console.error("Firebase config no est√° disponible. Las funciones de guardado en la nube estar√°n deshabilitadas.");
        window.db = undefined;
    }
    
    // Necesitamos cargar nuestro script de l√≥gica despu√©s de inicializar Firebase
    // Esto es un placeholder ya que el entorno de Canvas cargar√° autom√°ticamente el archivo my-app-logic.js
    // pero aseguramos que las variables globales 'db' y 'firebase' est√©n definidas.
    window.firebase = firebase;
</script>

<!-- Tu archivo de l√≥gica de la aplicaci√≥n (my-app-logic.js) se cargar√° a continuaci√≥n en el entorno Canvas -->
